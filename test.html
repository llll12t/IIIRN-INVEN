<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- LIFF + Firebase + jsQR -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">

  <!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å -->
  <div id="homePage" class="max-w-md mx-auto p-6 bg-gray-200 rounded-2xl mt-6">
    <h2 class="text-xl font-semibold mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
    <p id="empName" class="font-semibold mb-1">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...</p>
    <p id="empPosition" class="text-gray-600 mb-4">&nbsp;</p>
    <div class="flex space-x-2 mb-4">
      <button onclick="showPage('borrow')" class="flex-1 bg-[#0A1E49] text-white py-2 rounded-xl font-bold">‚Üë ‡∏¢‡∏∑‡∏°</button>
      <button onclick="showPage('return')" class="flex-1 bg-[#FF9966] text-white py-2 rounded-xl font-bold">‚Üì ‡∏Ñ‡∏∑‡∏ô</button>
    </div>
    <table class="w-full border-collapse">
      <thead>
        <tr>
          <th class="py-2 px-4 bg-[#1c2950] text-white">‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
          <th class="py-2 px-4 bg-[#1c2950] text-white">‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
        </tr>
      </thead>
      <tbody id="borrowedList"></tbody>
    </table>
  </div>

  <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏¢‡∏∑‡∏° -->
  <div id="borrowPage" class="max-w-md mx-auto p-6 bg-gray-200 rounded-2xl mt-6 hidden">
    <h2 class="text-xl font-semibold mb-4">‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
    <div class="flex space-x-2 mb-4">
      <button onclick="startScan('borrow')" class="flex-1 bg-[#0A1E49] text-white py-2 rounded-xl font-bold flex items-center justify-center gap-2">
        üì∑ Scan QR
      </button>
      <button onclick="showPage('home')" class="flex-1 bg-white border border-gray-300 py-2 rounded-xl font-bold">
        ‚Üê ‡∏Å‡∏•‡∏±‡∏ö
      </button>
    </div>
    <video id="video" playsinline class="w-full rounded-lg mb-4 hidden"></video>
    <ul id="basketBorrow" class="mb-4 space-y-2"></ul>
    <p id="scanStatusBorrow" class="font-semibold mb-4"></p>
    <button onclick="openModal('borrow')" class="w-full bg-[#0A1E49] text-white py-2 rounded-xl font-bold">
      ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏∑‡∏°
    </button>
  </div>

  <!-- ‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå -->
  <div id="returnPage" class="max-w-md mx-auto p-6 bg-gray-200 rounded-2xl mt-6 hidden">
    <h2 class="text-xl font-semibold mb-4">‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
    <div class="flex space-x-2 mb-4">
      <button onclick="startScan('return')" class="flex-1 bg-[#0A1E49] text-white py-2 rounded-xl font-bold flex items-center justify-center gap-2">
        üì∑ Scan QR
      </button>
      <button onclick="showPage('home')" class="flex-1 bg-white border border-gray-300 py-2 rounded-xl font-bold">
        ‚Üê ‡∏Å‡∏•‡∏±‡∏ö
      </button>
    </div>
    <video id="videoReturn" playsinline class="w-full rounded-lg mb-4 hidden"></video>
    <ul id="basketReturn" class="mb-4 space-y-2"></ul>
    <p id="scanStatusReturn" class="font-semibold mb-4"></p>
    <button onclick="openModal('return')" class="w-full bg-[#FF9966] text-white py-2 rounded-xl font-bold">
      ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏∑‡∏ô
    </button>
  </div>

  <!-- Confirm Modal -->
  <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-2xl p-6 w-11/12 max-w-sm">
      <h3 id="modalTitle" class="text-lg font-semibold mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</h3>
      <p id="modalMessage" class="mb-6">‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?</p>
      <div id="modalActions" class="flex justify-end space-x-2">
        <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 rounded-lg font-medium">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        <button id="btnConfirm" onclick="confirmSubmit()" class="px-4 py-2 bg-[#0A1E49] text-white rounded-lg font-medium">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
      </div>
      <div id="modalClose" class="flex justify-end hidden">
        <button onclick="closeModal()" class="px-4 py-2 bg-[#0A1E49] text-white rounded-lg font-medium">
          ‡∏õ‡∏¥‡∏î (<span id="countdown">3</span>)
        </button>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {/* ... */};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const LIFF_ID = "2007335399-4yV9bMq0";
    let userIdLine="",userName="",userPosition="";
    let basket=[],currentMode="",pendingMode=null;

    async function initLIFF(){
      await liff.init({liffId:LIFF_ID});
      if(!liff.isLoggedIn()) liff.login();
      const p=await liff.getProfile();
      userIdLine=p.userId;
      const empSnap=await db.ref("employees")
        .orderByChild("userIdLine").equalTo(userIdLine).get();
      if(empSnap.exists()){
        const emp=Object.values(empSnap.val())[0];
        userName=emp.fullName; userPosition=emp.position;
      }else{
        userName=p.displayName; userPosition="‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á";
      }
      document.getElementById("empName").textContent=`üë§ ${userName}`;
      document.getElementById("empPosition").textContent=`‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: ${userPosition}`;
      loadBorrowed();
    }

    function showPage(page){
      ["homePage","borrowPage","returnPage"].forEach(id=>
        document.getElementById(id).classList.add("hidden")
      );
      document.getElementById(`${page}Page`).classList.remove("hidden");
      basket=[]; updateList();
      document.getElementById(page==="borrow"?"scanStatusBorrow":"scanStatusReturn").textContent="";
      const v=page==="borrow"?document.getElementById("video"):document.getElementById("videoReturn");
      if(v.srcObject){v.srcObject.getTracks().forEach(t=>t.stop()); v.classList.add("hidden")}
      currentMode=page;
      if(page==="home") loadBorrowed();
    }

    async function loadBorrowed(){
      const tb=document.getElementById("borrowedList"); tb.innerHTML="";
      const snap=await db.ref("devices").once("value");
      snap.forEach(c=>{
        const d=c.val();
        if(d.status==="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" && d.lastUser.includes(userName)){
          tb.innerHTML+=`<tr>
            <td class="py-2 px-4 border">${d.deviceId}</td>
            <td class="py-2 px-4 border">${d.deviceName}</td>
          </tr>`;
        }
      });
    }

    async function startScan(mode){
      currentMode=mode;
      const video= mode==="borrow"?document.getElementById("video"):document.getElementById("videoReturn");
      const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
      video.srcObject=stream; video.play(); video.classList.remove("hidden");
      tick(video);
    }

    function tick(video){
      if(video.readyState===video.HAVE_ENOUGH_DATA){
        const c=document.createElement("canvas");
        c.width=video.videoWidth; c.height=video.videoHeight;
        c.getContext("2d").drawImage(video,0,0);
        const code=jsQR(c.getContext("2d").getImageData(0,0,c.width,c.height).data,c.width,c.height);
        if(code) handleScanResult(code.data.trim());
      }
      if(video.srcObject) requestAnimationFrame(()=>tick(video));
    }

    async function handleScanResult(deviceId){
      const statusEl=document.getElementById(currentMode==="borrow"?"scanStatusBorrow":"scanStatusReturn");
      if(!deviceId){
        statusEl.textContent="‚ùå ‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"; return;
      }
      const snap=await db.ref("devices/"+deviceId).get();
      if(!snap.exists()){
        statusEl.textContent=`‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${deviceId}`; return;
      }
      const dev=snap.val();
      if(!dev.deviceName){
        statusEl.textContent=`‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${deviceId}`; return;
      }
      if(currentMode==="borrow" && dev.status==="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"){
        statusEl.textContent=`‚ö†Ô∏è ${deviceId} (${dev.deviceName}) ‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß`; return;
      }
      if(!basket.includes(deviceId)){
        basket.push(deviceId); updateList();
      }
      statusEl.textContent=`‚úÖ ‡πÄ‡∏à‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${deviceId} (${dev.deviceName})`;
    }

    function updateList(){
      const el=document.getElementById(currentMode==="borrow"?"basketBorrow":"basketReturn");
      el.innerHTML=basket.map(id=>`
        <li class="flex justify-between items-center bg-white p-2 rounded-lg shadow">
          <span>üì¶ ${id}</span>
          <button onclick="removeFromBasket('${id}')" class="text-red-500 font-bold">‡∏•‡∏ö</button>
        </li>
      `).join("");
    }

    function removeFromBasket(id){
      basket=basket.filter(x=>x!==id); updateList();
    }

    function openModal(mode){
      pendingMode=mode;
      if(basket.length===0){
        document.getElementById("modalTitle").textContent="‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£";
        document.getElementById("modalMessage").textContent="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡πÅ‡∏Å‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£";
        document.getElementById("modalActions").classList.add("hidden");
        document.getElementById("modalClose").classList.remove("hidden");
        return document.getElementById("confirmModal").classList.remove("hidden");
      }
      document.getElementById("modalTitle").textContent="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£";
      document.getElementById("modalMessage").textContent="‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?";
      document.getElementById("modalActions").classList.remove("hidden");
      document.getElementById("modalClose").classList.add("hidden");
      document.getElementById("confirmModal").classList.remove("hidden");
    }

    function closeModal(){
      document.getElementById("confirmModal").classList.add("hidden");
      pendingMode=null;
    }

    async function confirmSubmit(){
      if(!pendingMode) return;
      await submitAction(pendingMode);
      document.getElementById("modalTitle").textContent="‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!";
      document.getElementById("modalMessage").textContent="‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å‡πÉ‡∏ô‡∏≠‡∏µ‡∏Å";
      document.getElementById("modalActions").classList.add("hidden");
      document.getElementById("modalClose").classList.remove("hidden");
      startCountdown();
      pendingMode=null;
    }

    function startCountdown(){
      let count=3;
      const cnt=document.getElementById("countdown");
      cnt.textContent=count;
      const iv=setInterval(()=>{
        count--;
        if(count<=0){
          clearInterval(iv);
          closeModal();
          showPage("home");
        } else cnt.textContent=count;
      },1000);
    }

    async function submitAction(mode){
      const refName=mode==="borrow"?"borrowRecords":"returnRecords";
      const statusText=mode==="borrow"?"‡∏¢‡∏∑‡∏°":"‡∏Ñ‡∏∑‡∏ô";
      const now=new Date().toISOString();
      for(const deviceId of basket){
        const snap=await db.ref("devices/"+deviceId).get();
        if(!snap.exists()) continue;
        const dev=snap.val();
        if(mode==="borrow"&&dev.status==="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô") continue;
        const recId=db.ref().child(refName).push().key;
        await db.ref(`${refName}/${recId}`).set({
          deviceId, deviceName: dev.deviceName,
          userId: userIdLine, userName, userPosition,
          status: statusText, date: now
        });
        await db.ref("devices/"+deviceId).update({
          status:mode==="borrow"?"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô":"‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
          lastUser:`${userName} (${userPosition})`,
          lastUserId:mode==="borrow"?userIdLine:""
        });
      }
    }

    initLIFF();
  </script>
</body>
</html>
