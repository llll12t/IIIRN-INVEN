<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- LIFF + Firebase + jsQR -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #efefef;
    }
    .page {
      max-width: 400px;
      margin: 20px auto;
      padding: 20px;
      background: #f4f4f4;
      border-radius: 16px;
    }
    .hidden { display: none; }
    button {
      border: none;
      border-radius: 14px;
      padding: 12px;
      font-weight: bold;
      margin: 5px 4px;
      width: 48%;
    }
    .btn-borrow {
      background: #0A1E49;
      color: #fff;
    }
    .btn-return {
      background: #FF9966;
      color: #fff;
    }
    .btn-back {
      background: #fff;
      border: 1px solid #ccc;
      color: #333;
    }
    .btn-remove {
      background: #FF5252;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 0.9em;
    }
    .btn-remove:hover {
      opacity: 0.8;
      cursor: pointer;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th {
      background: #1c2950;
      color: #fff;
    }
    td {
      background: #fff;
    }
    video {
      display: none;
      width: 100%;
      border-radius: 10px;
      margin-top: 10px;
    }
    #scanStatus {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å -->
  <div class="page" id="homePage">
    <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
    <p id="empInfo">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô...</p>
    <div style="display:flex; justify-content:space-between;">
      <button class="btn-borrow" onclick="showPage('borrow')">‚Üë ‡∏¢‡∏∑‡∏°</button>
      <button class="btn-return" onclick="showPage('return')">‚Üì ‡∏Ñ‡∏∑‡∏ô</button>
    </div>
    <table>
      <thead>
        <tr><th>‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th></tr>
      </thead>
      <tbody id="borrowedList"></tbody>
    </table>
  </div>

  <!-- ‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå -->
  <div class="page hidden" id="borrowPage">
    <h2>‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
    <div style="display:flex; justify-content:space-between;">
      <button class="btn-borrow" onclick="startScan('borrow')">üì∑ Scan QR</button>
      <button class="btn-back" onclick="showPage('home')">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
    </div>
    <video id="videoBorrow" playsinline></video>
    <!-- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ -->
    <table>
      <thead>
        <tr><th>‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th><th></th></tr>
      </thead>
      <tbody id="basketBorrowBody"></tbody>
    </table>
    <p id="scanStatus"></p>
    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≠‡∏ö‡πÅ‡∏£‡∏Å -->
    <button id="borrowSubmitBtn" class="btn-borrow" onclick="showConfirm('borrow')">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏∑‡∏°</button>
    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏≠‡∏ö‡∏™‡∏≠‡∏á -->
    <div id="borrowConfirmBtns" class="hidden" style="display:flex; justify-content:space-between; margin-top:10px;">
      <button class="btn-borrow" onclick="submitAction('borrow')">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
      <button class="btn-back" onclick="cancelConfirm('borrow')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>

  <!-- ‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå -->
  <div class="page hidden" id="returnPage">
    <h2>‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
    <div style="display:flex; justify-content:space-between;">
      <button class="btn-return" onclick="startScan('return')">üì∑ Scan QR</button>
      <button class="btn-back" onclick="showPage('home')">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
    </div>
    <video id="videoReturn" playsinline></video>
    <table>
      <thead>
        <tr><th>‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th><th></th></tr>
      </thead>
      <tbody id="basketReturnBody"></tbody>
    </table>
    <p id="scanStatus"></p>
    <button id="returnSubmitBtn" class="btn-return" onclick="showConfirm('return')">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏∑‡∏ô</button>
    <div id="returnConfirmBtns" class="hidden" style="display:flex; justify-content:space-between; margin-top:10px;">
      <button class="btn-return" onclick="submitAction('return')">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
      <button class="btn-back" onclick="cancelConfirm('return')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
  </div>

  <script>
    // --- Initialization ‡πÅ‡∏•‡∏∞ LIFF/Firebase ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ---
    const firebaseConfig = { /* ‚Ä¶ */ };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const LIFF_ID = "2007335399-4yV9bMq0";
    let userIdLine="", userName="", userPosition="";
    let basket = [], currentMode="";

    async function initLIFF(){
      await liff.init({ liffId: LIFF_ID });
      if(!liff.isInClient()&&!liff.isLoggedIn()){ liff.login(); return; }
      const profile = await liff.getProfile();
      userIdLine = profile.userId;
      // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å Firebase
      const empSnap = await db.ref("employees").orderByChild("userIdLine").equalTo(userIdLine).get();
      if(empSnap.exists()){
        const emp = Object.values(empSnap.val())[0];
        userName = emp.fullName; userPosition = emp.position;
      } else {
        userName = profile.displayName; userPosition = "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á";
      }
      document.getElementById("empInfo").textContent = `üë§ ${userName} (${userPosition})`;
      loadBorrowed();
    }

    function showPage(page){
      ["homePage","borrowPage","returnPage"].forEach(id=>
        document.getElementById(id).classList.add("hidden")
      );
      document.getElementById(page+"Page").classList.remove("hidden");
      basket = [];
      updateList();
      document.getElementById("scanStatus").textContent = "";
      if(page==="home") loadBorrowed();
    }

    async function loadBorrowed(){
      const tbody = document.getElementById("borrowedList");
      tbody.innerHTML = "";
      const snap = await db.ref("devices").once("value");
      snap.forEach(child=>{
        const d = child.val();
        if(d.status==="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" && d.lastUser.includes(userName)){
          tbody.innerHTML += `<tr><td>${d.deviceId}</td><td>${d.deviceName}</td></tr>`;
        }
      });
    }

    async function startScan(mode){
      currentMode = mode;
      const video = document.getElementById(mode==="borrow"?"videoBorrow":"videoReturn");
      const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
      video.srcObject = stream; video.play(); video.style.display="block";
      requestAnimationFrame(()=>tick(video));
    }

    function tick(video){
      if(video.readyState===video.HAVE_ENOUGH_DATA){
        const canvas = document.createElement("canvas"), ctx=canvas.getContext("2d");
        canvas.width=video.videoWidth; canvas.height=video.videoHeight;
        ctx.drawImage(video,0,0);
        const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
        const code = jsQR(imageData.data,imageData.width,imageData.height);
        const scanStatus = document.getElementById("scanStatus");
        if(code){
          const deviceId = code.data.trim();
          db.ref("devices/"+deviceId).get().then(snap=>{
            if(!snap.exists()){
              scanStatus.textContent=`‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö: ${deviceId}`; scanStatus.style.color="red"; return;
            }
            const dev = snap.val();
            if(currentMode==="borrow" && dev.status==="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"){
              scanStatus.textContent=`‚ö†Ô∏è ${deviceId} ‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß`; scanStatus.style.color="orange"; return;
            }
            if(!basket.includes(deviceId)){
              basket.push(deviceId);
              updateList();
            }
            scanStatus.textContent=`‚úÖ ‡πÄ‡∏à‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${deviceId}`; scanStatus.style.color="green";
          });
        }
      }
      if(video.srcObject) requestAnimationFrame(()=>tick(video));
    }

    function updateList(){
      const tbody = document.getElementById(
        currentMode==="borrow"?"basketBorrowBody":"basketReturnBody"
      );
      tbody.innerHTML = "";
      basket.forEach(id=>{
        db.ref("devices/"+id).get().then(snap=>{
          const dev = snap.val();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${id}</td>
            <td>${dev.deviceName||"-"}</td>
            <td><button class="btn-remove" onclick="removeFromBasket('${id}')">X</button></td>
          `;
          tbody.appendChild(tr);
        });
      });
    }

    function removeFromBasket(id){
      basket = basket.filter(x=>x!==id);
      updateList();
    }

    function showConfirm(mode){
      document.getElementById(mode+"SubmitBtn").classList.add("hidden");
      document.getElementById(mode+"ConfirmBtns").classList.remove("hidden");
    }
    function cancelConfirm(mode){
      document.getElementById(mode+"ConfirmBtns").classList.add("hidden");
      document.getElementById(mode+"SubmitBtn").classList.remove("hidden");
    }

    async function submitAction(mode){
      const refName = mode==="borrow"?"borrowRecords":"returnRecords";
      const statusText = mode==="borrow"?"‡∏¢‡∏∑‡∏°":"‡∏Ñ‡∏∑‡∏ô";
      const now = new Date().toISOString();
      for(let deviceId of basket){
        const snap = await db.ref("devices/"+deviceId).get();
        if(!snap.exists()) continue;
        const dev = snap.val();
        if(mode==="borrow" && dev.status==="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô") continue;
        const recId = db.ref().child(refName).push().key;
        await db.ref(`${refName}/${recId}`).set({
          deviceId, deviceName:dev.deviceName||"-", userId:userIdLine,
          userName, userPosition, status:statusText, date:now
        });
        await db.ref("devices/"+deviceId).update({
          status: mode==="borrow"?"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô":"‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
          lastUser: `${userName} (${userPosition})`,
          lastUserId: mode==="borrow"?userIdLine:""
        });
      }
      alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      showPage("home");
    }

    initLIFF();
  </script>
</body>
</html>
