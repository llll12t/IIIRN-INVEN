<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <!-- jsQR for QR code scanning -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
    .form { background: white; padding: 20px; border-radius: 10px; max-width: 400px; margin: auto; }
    input, button { width: 100%; margin-bottom: 12px; padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
    button { background: #0A1E49; color: white; font-weight: bold; border: none; }
    video { width: 100%; border-radius: 10px; margin-top: 10px; }
    #output { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>

<div class="form">
  <h2>‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
  <p>‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: <span id="displayName">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span></p>
  <p>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: <span id="userPosition">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span></p>
  <button onclick="startScan('borrow')">üì• ‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
  <button onclick="startScan('return')">üì§ ‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
  <video id="video" autoplay playsinline></video>
  <p id="output"></p>
</div>

<script>
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBOCnA32ir0bHOlfIOvJ_ltAj65A5DJSlk",
    authDomain: "register-58eea.firebaseapp.com",
    databaseURL: "https://register-58eea-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "register-58eea",
    storageBucket: "register-58eea.appspot.com",
    messagingSenderId: "629204385342",
    appId: "1:629204385342:web:1d9c20a8b3f57269e09b6f"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const LIFF_ID = "2007335399-4yV9bMq0"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô LIFF ID ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

  let userIdLine = "";
  let userName = "";
  let userPosition = "";

  // Initialize LIFF
  window.onload = async () => {
    await liff.init({ liffId: LIFF_ID });
    if (!liff.isInClient() && !liff.isLoggedIn()) {
      liff.login();
      return;
    }
    const profile = await liff.getProfile();
    userIdLine = profile.userId;

    // Fetch employee data
    const empSnap = await db.ref("employees").orderByChild("userIdLine").equalTo(userIdLine).get();
    if (empSnap.exists()) {
      const emp = Object.values(empSnap.val())[0];
      userName = emp.fullName;
      userPosition = emp.position;
    } else {
      userName = profile.displayName;
      userPosition = "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á";
    }
    document.getElementById("displayName").textContent = userName;
    document.getElementById("userPosition").textContent = userPosition;
  };

  // QR code scanning
  const video = document.getElementById('video');
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  let currentAction = '';

  async function startCamera() {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;
  }

  function startScan(action) {
    currentAction = action;
    startCamera().then(() => requestAnimationFrame(tick));
  }

  function tick() {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, canvas.width, canvas.height);
      if (code) {
        handleQR(code.data.trim());
        video.srcObject.getTracks().forEach(track => track.stop());
        return;
      }
    }
    requestAnimationFrame(tick);
  }

  async function handleQR(deviceId) {
    const deviceSnap = await db.ref("devices/" + deviceId).get();
    if (!deviceSnap.exists()) {
      document.getElementById("output").textContent = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏£‡∏´‡∏±‡∏™ " + deviceId;
      return;
    }
    const device = deviceSnap.val();
    const now = new Date().toISOString();
    const statusText = currentAction === 'borrow' ? '‡∏¢‡∏∑‡∏°' : '‡∏Ñ‡∏∑‡∏ô';
    const refName = currentAction === 'borrow' ? 'borrowRecords' : 'returnRecords';
    const recId = db.ref().child(refName).push().key;

    // Save record
    await db.ref(`${refName}/${recId}`).set({
      deviceId,
      deviceName: device.deviceName || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠",
      userId: userIdLine,
      userName,
      userPosition,
      status: statusText,
      date: now
    });

    // Update device status
    await db.ref("devices/" + deviceId).update({
      status: currentAction === "borrow" ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" : "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
      lastUser: `${userName} (${userPosition})`
    });

    document.getElementById("output").textContent = `‚úÖ ${statusText}‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ${deviceId} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`;
  }
</script>

</body>
</html>
