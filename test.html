<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°‡∏Ñ‡∏∑‡∏ô</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; background: #efefef; }
    .page { max-width: 400px; margin: auto; padding: 20px; background: #f4f4f4; border-radius: 16px; }
    .hidden { display: none; }
    h2 { margin-top: 0; }
    button {
      border: none;
      border-radius: 14px;
      padding: 12px 16px;
      font-weight: bold;
      margin: 5px 4px;
      width: 45%;
    }
    .btn-scan { background: #0A1E49; color: white; }
    .btn-back { background: white; border: 1px solid #ccc; }
    .btn-borrow { background: #0A1E49; color: white; }
    .btn-return { background: #FF9966; color: white; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: center; }
    th { background: #1c2950; color: white; }
    td { background: white; }
    video { display: none; width: 100%; border-radius: 10px; margin-top: 10px; }
  </style>
</head>
<body>

<!-- ‡∏´‡∏ô‡πâ‡∏≤ Home -->
<div class="page" id="homePage">
  <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏¢‡∏∑‡∏° ‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
  <p>‡∏ä‡∏∑‡πà‡∏≠ ‡∏™‡∏Å‡∏∏‡∏•<br>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: demo</p>
  <div style="display: flex; justify-content: space-between;">
    <button class="btn-borrow" onclick="showPage('borrow')">‚Üë ‡∏¢‡∏∑‡∏°</button>
    <button class="btn-return" onclick="showPage('return')">‚Üì ‡∏Ñ‡∏∑‡∏ô</button>
  </div>
  <table>
    <thead>
      <tr><th>‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th></tr>
    </thead>
    <tbody id="borrowedList"></tbody>
  </table>
</div>

<!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏¢‡∏∑‡∏° -->
<div class="page hidden" id="borrowPage">
  <h2>‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
  <p>‡∏ä‡∏∑‡πà‡∏≠ ‡∏™‡∏Å‡∏∏‡∏•<br>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: demo</p>
  <div style="display: flex; justify-content: space-between;">
    <button class="btn-scan" onclick="startScan('borrow')">üì∑ Scan QR</button>
    <button class="btn-back" onclick="showPage('home')">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
  </div>
  <video id="video" playsinline></video>
  <ul id="basketBorrow"></ul>
  <button class="btn-borrow" onclick="submitAction('borrow')">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏∑‡∏°</button>
</div>

<!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏∑‡∏ô -->
<div class="page hidden" id="returnPage">
  <h2>‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
  <p>‡∏ä‡∏∑‡πà‡∏≠ ‡∏™‡∏Å‡∏∏‡∏•<br>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: demo</p>
  <div style="display: flex; justify-content: space-between;">
    <button class="btn-scan" onclick="startScan('return')">üì∑ Scan QR</button>
    <button class="btn-back" onclick="showPage('home')">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
  </div>
  <video id="videoReturn" playsinline></video>
  <ul id="basketReturn"></ul>
  <button class="btn-return" onclick="submitAction('return')">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏∑‡∏ô</button>
</div>

<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyBOCnA32ir0bHOlfIOvJ_ltAj65A5DJSlk",
authDomain: "register-58eea.firebaseapp.com",
databaseURL: "https://register-58eea-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId: "register-58eea",
storageBucket: "register-58eea.firebasestorage.app",
messagingSenderId: "629204385342",
appId: "1:629204385342:web:1d9c20a8b3f57269e09b6f",
measurementId: "G-FFLKXCZE64"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const userId = "U001";
  const userName = "‡∏Ñ‡∏∏‡∏ì‡∏™‡∏Å‡∏∏‡∏•";
  let basket = [];
  let currentMode = "";

  function showPage(page) {
    document.getElementById("homePage").classList.add("hidden");
    document.getElementById("borrowPage").classList.add("hidden");
    document.getElementById("returnPage").classList.add("hidden");
    document.getElementById(`${page}Page`).classList.remove("hidden");
    basket = [];
    updateList();
    if (page === "home") loadBorrowed();
  }

  async function loadBorrowed() {
    const tbody = document.getElementById("borrowedList");
    tbody.innerHTML = "";
    const snapshot = await db.ref("devices").once("value");
    snapshot.forEach(child => {
      const d = child.val();
      if (d.status === "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" && d.lastUser === userName) {
        tbody.innerHTML += `<tr><td>${d.deviceId}</td><td>${d.deviceName}</td></tr>`;
      }
    });
  }

  async function startScan(mode) {
    currentMode = mode;
    const video = document.getElementById(mode === "borrow" ? "video" : "videoReturn");
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;
    video.style.display = "block";
    video.play();
    requestAnimationFrame(() => scanLoop(video));
  }

  function scanLoop(video) {
    const canvas = document.createElement("canvas");
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, canvas.width, canvas.height);
    if (code) {
      const id = code.data.trim();
      if (!basket.includes(id)) {
        basket.push(id);
        updateList();
      }
    }
    if (video.srcObject) requestAnimationFrame(() => scanLoop(video));
  }

  function updateList() {
    document.getElementById("basketBorrow").innerHTML = basket.map(id => `<li>üì¶ ${id}</li>`).join('');
    document.getElementById("basketReturn").innerHTML = basket.map(id => `<li>üì¶ ${id}</li>`).join('');
  }

  async function submitAction(mode) {
    const refName = mode === "borrow" ? "borrowRecords" : "returnRecords";
    const statusText = mode === "borrow" ? "‡∏¢‡∏∑‡∏°" : "‡∏Ñ‡∏∑‡∏ô";
    const now = new Date().toISOString();

    for (let deviceId of basket) {
      const snap = await db.ref("devices/" + deviceId).get();
      if (!snap.exists()) {
        alert(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${deviceId}`);
        continue;
      }

      const dev = snap.val();

      if (mode === "borrow" && dev.status === "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô") {
        alert(`‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ${deviceId} ‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà`);
        continue;
      }

      const recId = db.ref().child(refName).push().key;
      await db.ref(`${refName}/${recId}`).set({
        deviceId,
        deviceName: dev.deviceName || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠",
        userId,
        userName,
        status: statusText,
        date: now
      });

      await db.ref("devices/" + deviceId).update({
        status: mode === "borrow" ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" : "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
        lastUser: userName
      });
    }

    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    showPage("home");
  }

  // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°
  loadBorrowed();
</script>

</body>
</html>
