<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°-‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <style>
    body { font-family: sans-serif; background: #efefef; }
    .page { max-width: 400px; margin: auto; padding: 20px; background: #f4f4f4; border-radius: 16px; }
    .hidden { display: none; }
    h2 { margin-top: 0; }
    button {
      border: none; border-radius: 14px; padding: 12px 16px;
      font-weight: bold; margin: 5px 4px; width: 45%;
    }
    .btn-scan { background: #0A1E49; color: white; }
    .btn-back { background: white; border: 1px solid #ccc; }
    .btn-borrow { background: #0A1E49; color: white; }
    .btn-return { background: #FF9966; color: white; }
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { padding: 8px; border: 1px solid #ddd; text-align: center; }
    th { background: #1c2950; color: white; }
    td { background: white; }
    video { display: none; width: 100%; border-radius: 10px; margin-top: 10px; }
    #scanStatus { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>

<div class="page" id="homePage">
  <h2>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏¢‡∏∑‡∏° ‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
  <p>‡∏ä‡∏∑‡πà‡∏≠ ‡∏™‡∏Å‡∏∏‡∏•<br>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á: demo</p>
  <div style="display: flex; justify-content: space-between;">
    <button class="btn-borrow" onclick="showPage('borrow')">‚Üë ‡∏¢‡∏∑‡∏°</button>
    <button class="btn-return" onclick="showPage('return')">‚Üì ‡∏Ñ‡∏∑‡∏ô</button>
  </div>
  <table>
    <thead><tr><th>‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th></tr></thead>
    <tbody id="borrowedList"></tbody>
  </table>
</div>

<div class="page hidden" id="borrowPage">
  <h2>‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
  <div style="display: flex; justify-content: space-between;">
    <button class="btn-scan" onclick="startScan('borrow')">üì∑ Scan QR</button>
    <button class="btn-back" onclick="showPage('home')">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
  </div>
  <video id="video" playsinline></video>
  <ul id="basketBorrow"></ul>
  <p id="scanStatus"></p>
  <button class="btn-borrow" onclick="submitAction('borrow')">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏∑‡∏°</button>
</div>

<div class="page hidden" id="returnPage">
  <h2>‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
  <div style="display: flex; justify-content: space-between;">
    <button class="btn-scan" onclick="startScan('return')">üì∑ Scan QR</button>
    <button class="btn-back" onclick="showPage('home')">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</button>
  </div>
  <video id="videoReturn" playsinline></video>
  <ul id="basketReturn"></ul>
  <p id="scanStatus"></p>
  <button class="btn-return" onclick="submitAction('return')">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Ñ‡∏∑‡∏ô</button>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBOCnA32ir0bHOlfIOvJ_ltAj65A5DJSlk",
authDomain: "register-58eea.firebaseapp.com",
databaseURL: "https://register-58eea-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId: "register-58eea",
storageBucket: "register-58eea.firebasestorage.app",
messagingSenderId: "629204385342",
appId: "1:629204385342:web:1d9c20a8b3f57269e09b6f",
measurementId: "G-FFLKXCZE64"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const userId = "U001";
  const userName = "‡∏Ñ‡∏∏‡∏ì‡∏™‡∏Å‡∏∏‡∏•";
  const canvas = document.createElement("canvas");
  const ctx = canvas.getContext("2d");
  let basket = [];
  let currentMode = "";

  function showPage(page) {
    ["homePage", "borrowPage", "returnPage"].forEach(id =>
      document.getElementById(id).classList.add("hidden")
    );
    document.getElementById(`${page}Page`).classList.remove("hidden");
    basket = [];
    updateList();
    document.getElementById("scanStatus").textContent = "";
    if (page === "home") loadBorrowed();
  }

  async function loadBorrowed() {
    const tbody = document.getElementById("borrowedList");
    tbody.innerHTML = "";
    const snapshot = await db.ref("devices").once("value");
    snapshot.forEach(child => {
      const d = child.val();
      if (d.status === "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" && d.lastUser === userName) {
        tbody.innerHTML += `<tr><td>${d.deviceId}</td><td>${d.deviceName}</td></tr>`;
      }
    });
  }

  async function startScan(mode) {
    currentMode = mode;
    const video = document.getElementById(mode === "borrow" ? "video" : "videoReturn");
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
    video.srcObject = stream;
    video.setAttribute("playsinline", true);
    video.play();
    video.style.display = "block";
    requestAnimationFrame(() => tick(video));
  }

  function tick(video) {
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      ctx.drawImage(video, 0, 0);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const code = jsQR(imageData.data, imageData.width, imageData.height);
      const scanStatus = document.getElementById("scanStatus");

      if (code) {
        const deviceId = code.data.trim();
        db.ref("devices/" + deviceId).get().then(snapshot => {
          if (!snapshot.exists()) {
            scanStatus.textContent = `‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${deviceId}`;
            scanStatus.style.color = "red";
            return;
          }
          const dev = snapshot.val();
          if (currentMode === "borrow" && dev.status === "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô") {
            scanStatus.textContent = `‚ö†Ô∏è ${deviceId} (${dev.deviceName}) ‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß`;
            scanStatus.style.color = "orange";
            return;
          }
          if (!basket.includes(deviceId)) {
            basket.push(deviceId);
            updateList();
          }
          scanStatus.textContent = `‚úÖ ‡πÄ‡∏à‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå: ${deviceId} (${dev.deviceName})`;
          scanStatus.style.color = "green";
        });
      }
    }
    if (video.srcObject) requestAnimationFrame(() => tick(video));
  }

  function updateList() {
    document.getElementById("basketBorrow").innerHTML = basket.map(id => `<li>üì¶ ${id}</li>`).join('');
    document.getElementById("basketReturn").innerHTML = basket.map(id => `<li>üì¶ ${id}</li>`).join('');
  }

  async function submitAction(mode) {
    const refName = mode === "borrow" ? "borrowRecords" : "returnRecords";
    const statusText = mode === "borrow" ? "‡∏¢‡∏∑‡∏°" : "‡∏Ñ‡∏∑‡∏ô";
    const now = new Date().toISOString();

    for (let deviceId of basket) {
      const snap = await db.ref("devices/" + deviceId).get();
      if (!snap.exists()) continue;

      const dev = snap.val();
      if (mode === "borrow" && dev.status === "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô") continue;

      const recId = db.ref().child(refName).push().key;
      await db.ref(`${refName}/${recId}`).set({
        deviceId,
        deviceName: dev.deviceName || "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏ä‡∏∑‡πà‡∏≠",
        userId,
        userName,
        status: statusText,
        date: now
      });

      await db.ref("devices/" + deviceId).update({
        status: mode === "borrow" ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô" : "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô",
        lastUser: userName
      });
    }

    alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    showPage("home");
  }

  loadBorrowed();
</script>
</body>
</html>
