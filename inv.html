<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏¢‡∏∑‡∏°‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (LIFF)</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .hidden { display: none; }
    #video { width: 100%; max-width: 400px; border-radius: 0.5rem; display: none; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

<!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å -->
<div id="homePage" class="bg-white p-6 rounded shadow w-full max-w-md text-center">
  <div class="mb-4">
    <img src="https://via.placeholder.com/100" class="mx-auto rounded-full mb-2" />
    <h1 id="displayName" class="text-xl font-bold mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h1>
    <p id="userId" class="text-gray-500 text-sm">UserID</p>
  </div>

  <div class="flex gap-4 mb-4">
    <button onclick="showPage('borrow')" class="bg-blue-500 text-white px-4 py-2 rounded w-full">‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
    <button onclick="showPage('return')" class="bg-yellow-500 text-white px-4 py-2 rounded w-full">‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
  </div>

  <div>
    <h2 class="text-lg font-bold mb-2">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°</h2>
    <table class="w-full text-sm border">
      <thead>
        <tr class="bg-gray-200">
          <th class="border px-2 py-1">‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
          <th class="border px-2 py-1">‡∏ä‡∏∑‡πà‡∏≠</th>
        </tr>
      </thead>
      <tbody id="borrowList"></tbody>
    </table>
  </div>
</div>

<!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå -->
<div id="borrowPage" class="hidden bg-white p-6 rounded shadow w-full max-w-md text-center">
  <button onclick="showPage('home')" class="text-sm text-gray-500 underline mb-4">üîô ‡∏Å‡∏•‡∏±‡∏ö</button>
  <h2 class="text-lg font-bold mb-2">‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
  <button onclick="startScan()" class="bg-black text-white px-4 py-2 rounded w-full mb-4">üì∑ Live Scan QR</button>
  <video id="video" playsinline></video>
  <ul id="basketList" class="text-left text-sm mt-4"></ul>
  <button onclick="submit('borrow')" class="bg-green-500 text-white px-4 py-2 rounded w-full mt-4">‚úÖ Submit</button>
</div>

<!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå -->
<div id="returnPage" class="hidden bg-white p-6 rounded shadow w-full max-w-md text-center">
  <button onclick="showPage('home')" class="text-sm text-gray-500 underline mb-4">üîô ‡∏Å‡∏•‡∏±‡∏ö</button>
  <h2 class="text-lg font-bold mb-2">‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
  <button onclick="startScan()" class="bg-black text-white px-4 py-2 rounded w-full mb-4">üì∑ Live Scan QR</button>
  <video id="videoReturn" playsinline></video>
  <ul id="basketListReturn" class="text-left text-sm mt-4"></ul>
  <button onclick="submit('return')" class="bg-green-500 text-white px-4 py-2 rounded w-full mt-4">‚úÖ Submit</button>
</div>

<script>

const API_URL = 'https://script.google.com/macros/s/AKfycbwijQzkvwZx4ucNi3n2gCg8brSECV1UxGS7ZR1nAsdpHmYGkCN6hrJyoeuxGsQxEqE5/exec';
const LIFF_ID = '2007335399-deQzG3E7';

let userId = "";
let userName = "";
let basket = [];
let currentMode = "";

window.onload = async () => {
  await liff.init({ liffId: LIFF_ID });
  const profile = await liff.getProfile();
  userId = profile.userId;
  document.getElementById('userId').textContent = userId;

  const res = await fetch(`${API_URL}?method=getUserName&userId=${userId}`);
  const data = await res.json();
  if (data.found) {
    userName = data.name;
    document.getElementById('displayName').textContent = userName;
  } else {
    userName = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠");
    document.getElementById('displayName').textContent = userName;
  }

  loadBorrowedList();
};

function showPage(page) {
  document.getElementById('homePage').classList.add('hidden');
  document.getElementById('borrowPage').classList.add('hidden');
  document.getElementById('returnPage').classList.add('hidden');
  if (page === 'home') document.getElementById('homePage').classList.remove('hidden');
  if (page === 'borrow') {
    document.getElementById('borrowPage').classList.remove('hidden');
    currentMode = 'borrow';
    basket = [];
    renderBasket();
  }
  if (page === 'return') {
    document.getElementById('returnPage').classList.remove('hidden');
    currentMode = 'return';
    basket = [];
    renderBasket();
  }
}

async function loadBorrowedList() {
  const res = await fetch(`${API_URL}?method=getUserBorrow&userId=${userId}`);
  const data = await res.json();
  const list = document.getElementById('borrowList');
  list.innerHTML = "";
  data.forEach((item, idx) => {
    list.innerHTML += `<tr><td class="border px-2">${item.deviceId}</td><td class="border px-2">${item.deviceName}</td></tr>`;
  });
}

async function startScan() {
  const videoId = currentMode === 'borrow' ? 'video' : 'videoReturn';
  const video = document.getElementById(videoId);
  video.style.display = 'block';
  const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
  video.srcObject = stream;
  video.play();
  requestAnimationFrame(() => tick(video, stream));
}

function stopScan(video) {
  if (video.srcObject) {
    video.srcObject.getTracks().forEach(t => t.stop());
    video.srcObject = null;
  }
  video.style.display = 'none';
}

async function tick(video, stream) {
  if (video.readyState === video.HAVE_ENOUGH_DATA) {
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, imageData.width, imageData.height);

    if (code) {
      stopScan(video);
      const id = code.data.trim();
      const res = await fetch(`${API_URL}?method=getDevice&deviceId=${id}`);
      const device = await res.json();
      if (!device.deviceId) return alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå');

      if (currentMode === 'borrow' && device.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô') {
        alert('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
        return;
      }

      basket.push(device);
      renderBasket();
    }
  }
  if (video.srcObject) requestAnimationFrame(() => tick(video, stream));
}

function renderBasket() {
  const listId = currentMode === 'borrow' ? 'basketList' : 'basketListReturn';
  const list = document.getElementById(listId);
  list.innerHTML = "";
  basket.forEach((item, idx) => {
    list.innerHTML += `<li class="border-b py-1 flex justify-between">
      <span>${item.deviceId} - ${item.deviceName}</span>
      <button onclick="removeFromBasket(${idx})">‚ùå</button>
    </li>`;
  });
}

function removeFromBasket(idx) {
  basket.splice(idx, 1);
  renderBasket();
}

async function submit(action) {
  if (!basket.length) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤");

  const payload = {
    action: action,
    userId: userId,
    userName: userName,
    basket: basket
  };

  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify(payload)
  });
  const text = await res.text();
  if (text.includes("success")) {
    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    basket = [];
    renderBasket();
    showPage('home');
    loadBorrowedList();
  } else {
    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
  }
}
</script>

</body>
</html>
