<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>‡∏¢‡∏∑‡∏°‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .hidden { display: none; }
    #video, #videoReturn {
      display: none;
      width: 100%;
      max-width: 400px;
      border-radius: 0.5rem;
    }
  </style>
</head>
<body class="bg-slate-100 flex items-center justify-center p-4 relative">

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white px-4 py-2 rounded shadow">
      <span id="loadingText" class="text-gray-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î ..</span>
    </div>
  </div>

  <!-- ‡∏´‡∏ô‡πâ‡∏≤ Home -->
  <div id="homePage" class="p-2 max-w-md w-full">
    <div class="flex col-3">
      <div><img id="profileImage" src="" alt="" class="w-10 h-10 rounded-full border-2"></div>
      <div id="displayName" class="text-xl font-bold pl-4"></div>
      <div id="userId" class="text-gray-500 text-sm hidden">userId</div>
    </div>
    <div class="flex gap-4 my-6">
      <button onclick="showPage('borrow')" class="bg-slate-800 text-white p-4 rounded-full w-full">‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
      <button onclick="showPage('return')" class="bg-orange-500 text-white p-4 rounded-full w-full">‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
    </div>
    <div class="p-2 border rounded-2xl bg-white">
    <h2 class="text-md font-bold mb-2 ">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏°</h2>
    <table class="w-full text-sm border">
      <thead>
        <tr class="bg-slate-800 text-white">
          <th class="border p-2 ">‡∏£‡∏´‡∏±‡∏™</th>
          <th class="border p-2 ">‡∏ä‡∏∑‡πà‡∏≠</th>
        </tr>
      </thead>
      <tbody id="borrowList"></tbody>
    </table>
  </div> 
</div>

  <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏¢‡∏∑‡∏° -->
  <div id="borrowPage" class="hidden p-2 max-w-md w-full">
    <div class="text-md mt-2">‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</div>
    <div class="flex justify-between mb-4">
      <button onclick="showPage('home')" class="bg-slate-400 text-white px-4 py-2 rounded-full mb-2">‡∏Å‡∏•‡∏±‡∏ö</button>
      <div class="text-md mt-2"><button onclick="startScan()" class="bg-slate-800 text-white px-4 py-2 rounded w-full mb-2">üì∑ Scan QR</button>
      </div>

    </div>
    <video id="video" playsinline></video>
    <ul id="basketList" class="text-left text-sm mt-4"></ul>
    <button onclick="submit('borrow')" class="bg-green-500 text-white px-4 py-2 rounded w-full mt-4">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
  </div>

  <!-- ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏∑‡∏ô -->
  <div id="returnPage" class="hidden p-2 max-w-md w-full">
    <div class="flex justify-between mb-4">
      <button onclick="showPage('home')" class="bg-slate-400 text-white px-4 py-2 rounded-full mb-2">‡∏Å‡∏•‡∏±‡∏ö</button>
      <div class="text-md mt-2">‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</div>
    </div>
    <button onclick="startScan()" class="bg-slate-800 text-white px-4 py-2 rounded w-full mb-2">üì∑ Scan QR</button>
    <video id="videoReturn" playsinline></video>
    <ul id="basketListReturn" class="text-left text-sm mt-4"></ul>
    <button onclick="submit('return')" class="bg-green-500 text-white px-4 py-2 rounded w-full mt-4">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwijQzkvwZx4ucNi3n2gCg8brSECV1UxGS7ZR1nAsdpHmYGkCN6hrJyoeuxGsQxEqE5/exec';
    const LIFF_ID = '2007335399-4yV9bMq0';

    let userId = "";
    let userName = "";
    let basket = [];
    let currentMode = "";

    // *** CAMERA STREAM REUSE ***
    let cameraStream = null;

    async function initCamera(video) {
      if (!cameraStream) {
        // ‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö stream ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
        cameraStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' }
        });
      }
      // ‡∏ï‡∏±‡πâ‡∏á srcObject ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ video element ‡πÉ‡∏´‡∏°‡πà
      video.srcObject = cameraStream;
      await video.play();
    }

    function enableCamera() {
      // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ã‡πâ‡∏≥
      cameraStream.getVideoTracks().forEach(t => t.enabled = true);
    }

    function disableCamera() {
      // ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏´‡∏¢‡∏∏‡∏î stream ‡∏à‡∏£‡∏¥‡∏á
      cameraStream.getVideoTracks().forEach(t => t.enabled = false);
    }
    // *** END CAMERA SETUP ***

    // Loader
    function showLoading(text = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î ..") {
      document.getElementById("loadingText").textContent = text;
      document.getElementById("loadingOverlay").classList.remove("hidden");
    }
    function hideLoading() {
      document.getElementById("loadingOverlay").classList.add("hidden");
    }

      window.onload = async () => {
        showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ..");
        await liff.init({ liffId: LIFF_ID });
      
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÉ‡∏ô LINE Client ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å liff.login()
        if (!liff.isInClient() && !liff.isLoggedIn()) {
          liff.login(); 
          return;  // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô reload
        }
      const profile = await liff.getProfile();
      userId = profile.userId;
      document.getElementById('userId').textContent = userId;
      document.getElementById('displayName').textContent = profile.displayName;
      document.getElementById('profileImage').src = profile.pictureUrl || 'https://placehold.co/400x400/EEE/31343C?font=noto-sans&text=IMG';

      try {
        // ‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô + ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
        const [resName, resBorrow] = await Promise.all([
          fetch(`${API_URL}?method=getUserName&userId=${userId}`),
          fetch(`${API_URL}?method=getUserBorrow&userId=${userId}`)
        ]);

        const dataName = await resName.json();
        const borrowData = await resBorrow.json();

        if (dataName.found) {
          userName = dataName.name;
          document.getElementById('displayName').textContent = userName;
        } else {
          userName = prompt("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠:");
          document.getElementById('displayName').textContent = userName;
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°
        const list = document.getElementById('borrowList');
        list.innerHTML = "";
        borrowData.forEach(item => {
          list.innerHTML += `<tr>
            <td class="border px-2">${item.deviceId}</td>
            <td class="border px-2">${item.deviceName}</td>
          </tr>`;
        });

      } catch (e) {
        console.error(e);
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ");
      }

      hideLoading();
    };


    function showPage(page) {
      ['homePage','borrowPage','returnPage'].forEach(id =>
        document.getElementById(id).classList.add('hidden')
      );
      if (page === 'home') document.getElementById('homePage').classList.remove('hidden');
      if (page === 'borrow') {
        currentMode = 'borrow';
        basket = [];
        renderBasket();
        document.getElementById('borrowPage').classList.remove('hidden');
      }
      if (page === 'return') {
        currentMode = 'return';
        basket = [];
        renderBasket();
        document.getElementById('returnPage').classList.remove('hidden');
      }
    }

    async function loadBorrowedList() {
      showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏∑‡∏° ..");
      try {
        const res = await fetch(`${API_URL}?method=getUserBorrow&userId=${userId}`);
        const data = await res.json();
        const list = document.getElementById('borrowList');
        list.innerHTML = "";
        data.forEach(item => {
          list.innerHTML += `<tr>
            <td class="border px-2">${item.deviceId}</td>
            <td class="border px-2">${item.deviceName}</td>
          </tr>`;
        });
      } catch (e) {
        console.error(e);
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏¢‡∏∑‡∏°‡πÑ‡∏î‡πâ");
      }
      hideLoading();
    }

    async function startScan() {
      const videoId = currentMode === 'borrow' ? 'video' : 'videoReturn';
      const video = document.getElementById(videoId);

      video.style.display = 'block';
      // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å initCamera ‡∏Ñ‡∏£‡∏±‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå
      await initCamera(video);
      // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á (track.enabled = true)
      enableCamera();
      requestAnimationFrame(() => tick(video));
    }

    function stopScan(video) {
      // ‡πÅ‡∏Ñ‡πà‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á ‡πÑ‡∏°‡πà stop stream ‡∏à‡∏£‡∏¥‡∏á
      disableCamera();
      video.style.display = 'none';
    }

    function tick(video) {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, imageData.width, imageData.height);

        if (code) {
          stopScan(video);
          const id = code.data.trim();
          showLoading("‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ..");
          fetch(`${API_URL}?method=getDevice&deviceId=${id}`)
            .then(r => r.json())
            .then(device => {
              hideLoading();
              if (!device.deviceId) return alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå");
              if (basket.some(i => i.deviceId === device.deviceId))
                return alert("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
              if (currentMode === 'borrow' && device.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô')
                return alert("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏¢‡∏∑‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß");
              basket.push(device);
              renderBasket();
            })
            .catch(e => {
              hideLoading();
              console.error(e);
              alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå");
            });
        }
      }
      // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏•‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ‡∏ß‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡∏ï‡πà‡∏≠
      if (cameraStream && cameraStream.getVideoTracks()[0].enabled) {
        requestAnimationFrame(() => tick(video));
      }
    }

    function renderBasket() {
      const listId = currentMode === 'borrow' ? 'basketList' : 'basketListReturn';
      const list = document.getElementById(listId);
      list.innerHTML = "";
      basket.forEach((item, idx) => {
        list.innerHTML += `<li class="border-b py-1 flex justify-between">
          <span>${item.deviceId} - ${item.deviceName}</span>
          <button onclick="removeFromBasket(${idx})">‚ùå</button>
        </li>`;
      });
    }

    function removeFromBasket(i) {
      basket.splice(i, 1);
      renderBasket();
    }

    async function submit(action) {
      if (!basket.length) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤");
      const payload = { action, userId, userName, basket };
      showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ..");
      try {
        const res = await fetch(API_URL, {
          method: "POST",
          body: JSON.stringify(payload)
        });
        const text = await res.text();
        hideLoading();
        if (text.includes("success")) {
          alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
          basket = [];
          renderBasket();
          showPage('home');
          loadBorrowedList();
        } else {
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
        }
      } catch (e) {
        hideLoading();
        console.error(e);
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ");
      }
    }
  </script>
</body>
</html>
