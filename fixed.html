<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>แจ้งซ่อมอุปกรณ์</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- LIFF + Firebase + jsQR -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6 font-sans">
  <div class="max-w-md mx-auto p-6">
    <h2 class="text-xl font-bold mb-4">แจ้งซ่อมอุปกรณ์</h2>
    <p class="mb-4">ชื่อผู้แจ้ง: <span id="reporterName" class="font-medium">กำลังโหลด...</span></p>

    <button id="scanBtn" class="w-full mb-4 flex items-center justify-center gap-2 bg-slate-800 hover:bg-slate-600 text-white py-2 px-4 rounded-full">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 7h4l2-3h6l2 3h4v13H3V7z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 11a4 4 0 100 8 4 4 0 000-8z" />
      </svg>
      สแกน QR อุปกรณ์
    </button>
    <video id="video" playsinline class="w-full rounded-lg mb-4 hidden"></video>

    <div class="space-y-4">
      <input id="deviceId" type="text" placeholder="รหัสอุปกรณ์" readonly
             class="w-full border border-gray-300 rounded-lg p-2" />
      <input id="deviceName" type="text" placeholder="ชื่ออุปกรณ์" readonly
             class="w-full border border-gray-300 rounded-lg p-2" />
      <input id="title" type="text" placeholder="หัวข้อปัญหา"
             class="w-full border border-gray-300 rounded-lg p-2" />
      <textarea id="details" placeholder="รายละเอียดเพิ่มเติม"
                class="w-full border border-gray-300 rounded-lg p-2"></textarea>
      <input id="imageInput" type="file" accept="image/*" class="w-full" />
      <img id="previewImage" src="#" alt="Preview" class="w-full rounded-lg hidden" />
    </div>

    <button id="openConfirmBtn"
            class="w-full mt-6 bg-green-500 hover:bg-green-600 text-white py-2 rounded-full">
      ส่งแจ้งซ่อม
    </button>
    <p id="statusText" class="mt-4 text-green-600 font-medium"></p>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg shadow-lg p-6 w-80">
      <h3 class="text-lg font-semibold mb-4">ยืนยันการแจ้งซ่อม</h3>
      <p class="mb-6">ต้องการส่งแจ้งซ่อมอุปกรณ์ใช่หรือไม่?</p>
      <div class="flex justify-end gap-4">
        <button id="cancelBtn" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">ยกเลิก</button>
        <button id="confirmBtn" class="px-4 py-2 rounded-lg bg-blue-500 hover:bg-blue-600 text-white">ยืนยัน</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBOCnA32ir0bHOlfIOvJ_ltAj65A5DJSlk",
      authDomain: "register-58eea.firebaseapp.com",
      databaseURL: "https://register-58eea-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "register-58eea",
      storageBucket: "register-58eea.appspot.com",
      messagingSenderId: "629204385342",
      appId: "1:629204385342:web:1d9c20a8b3f57269e09b6f",
      measurementId: "G-FFLKXCZE64"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    // LIFF init
    const LIFF_ID = "2007335399-BbMx4yd9";
    let userIdLine="", reporterName="";

    window.onload = async () => {
      await liff.init({ liffId: LIFF_ID });
      if(!liff.isInClient() && !liff.isLoggedIn()){
        liff.login(); return;
      }
      const profile = await liff.getProfile();
      userIdLine = profile.userId;
      const empSnap = await db.ref("employees")
        .orderByChild("userIdLine").equalTo(userIdLine).get();
      reporterName = empSnap.exists()
        ? Object.values(empSnap.val())[0].fullName
        : profile.displayName;
      document.getElementById("reporterName").textContent = reporterName;
    };

    // QR scan
    const canvas=document.createElement('canvas'), ctx=canvas.getContext('2d');
    document.getElementById('scanBtn').addEventListener('click', startScan);
    async function startScan(){
      const video=document.getElementById('video');
      const stream=await navigator.mediaDevices.getUserMedia({
        video:{facingMode:'environment'}
      });
      video.srcObject=stream; video.play();
      video.classList.remove('hidden');
      requestAnimationFrame(()=>scanLoop(video));
    }
    function scanLoop(video){
      if(video.readyState===video.HAVE_ENOUGH_DATA){
        canvas.width=video.videoWidth; canvas.height=video.videoHeight;
        ctx.drawImage(video,0,0);
        const code=jsQR(
          ctx.getImageData(0,0,canvas.width,canvas.height).data,
          canvas.width,canvas.height
        );
        if(code){
          const id=code.data.trim();
          db.ref(`devices/${id}`).get().then(snap=>{
            if(!snap.exists()) alert('ไม่พบอุปกรณ์นี้');
            else{
              document.getElementById('deviceId').value=id;
              document.getElementById('deviceName').value =
                snap.val().deviceName || 'ไม่ทราบชื่อ';
            }
          });
          video.srcObject.getTracks().forEach(t=>t.stop());
          video.classList.add('hidden');
          return;
        }
      }
      if(video.srcObject) requestAnimationFrame(()=>scanLoop(video));
    }

    // Preview image
    document.getElementById('imageInput')
      .addEventListener('change',e=>{
        const file=e.target.files[0];
        if(file){
          const reader=new FileReader();
          reader.onload=ev=>{
            const img=document.getElementById('previewImage');
            img.src=ev.target.result; img.classList.remove('hidden');
          };
          reader.readAsDataURL(file);
        }
      });

    // Modal
    const modal=document.getElementById('confirmModal');
    document.getElementById('openConfirmBtn').addEventListener('click',()=>{
      const dev=document.getElementById('deviceId').value.trim();
      const ti=document.getElementById('title').value.trim();
      const dt=document.getElementById('details').value.trim();
      if(!dev||!ti||!dt){
        alert('กรุณากรอกข้อมูลให้ครบ'); return;
      }
      modal.classList.remove('hidden');
    });
    document.getElementById('cancelBtn')
      .addEventListener('click',()=>modal.classList.add('hidden'));
    document.getElementById('confirmBtn')
      .addEventListener('click',async()=>{
        modal.classList.add('hidden');
        await submitRepair();
      });

    // Submit + send to LINE + close LIFF
    async function submitRepair(){
      const id=db.ref().child('repairReports').push().key;
      const now=new Date().toISOString();
      const dev=document.getElementById('deviceId').value.trim();
      const devName=document.getElementById('deviceName').value.trim();
      const ti=document.getElementById('title').value.trim();
      const dt=document.getElementById('details').value.trim();
      const file=document.getElementById('imageInput').files[0];

      // upload image
      let imageUrl='';
      if(file){
        const snap=await storage.ref(`repair_images/${id}`).put(file);
        imageUrl=await snap.ref.getDownloadURL();
      }

      // write to Firebase
      await db.ref(`repairReports/${id}`).set({
        id, date: now,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        reporterName,userIdLine,
        deviceId:dev,deviceName:devName,
        title:ti,details:dt,
        status:'รอซ่อม',imageUrl
      });

      // update device status
      await db.ref(`devices/${dev}`).update({
        status:'ส่งซ่อม',
        lastUser:reporterName,
        lastUserId:userIdLine
      });

      // send LINE message
      const msg=`แจ้งรายการซ่อม\nรหัส อุปกรณ์: ${dev}\nหัวข้อ: ${ti}\nรายละเอียด: ${dt}`;
      await liff.sendMessages([{type:'text',text:msg}]);

      // feedback + close
      document.getElementById('statusText').textContent='✅ แจ้งซ่อมเรียบร้อยแล้ว';
      setTimeout(()=>{
        if(liff.isInClient()) liff.closeWindow();
      },1000);
    }
  </script>
</body>
</html>
