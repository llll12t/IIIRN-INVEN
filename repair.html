<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
</head>
<body class="bg-gray-100 p-4 relative">

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white px-4 py-2 rounded shadow text-center">
      <span id="loadingText" class="text-gray-800">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î ..</span>
    </div>
  </div>

  <div class="max-w-md mx-auto bg-white p-6 rounded shadow">
    <h2 class="text-xl font-bold mb-4">üìã ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
    <div id="profileInfo" class="text-md text-gray-700 mb-4"></div>

    <!-- ‡∏™‡πÅ‡∏Å‡∏ô QR -->
    <video id="video" class="hidden w-full rounded mb-2" playsinline></video>
    <button onclick="startScan()" class="bg-gray-800 text-white p-4 rounded-full mb-4 w-full">
      üì∑ ‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
    </button>

    <!-- ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏Å‡∏£‡∏≠‡∏Å -->
     <div class="p-2 bg-white">
    <input id="deviceId" class="w-full border rounded-lg p-2 mb-2" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå" />
    <input id="deviceName" class="w-full border rounded-lg p-2 mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå" />
    <input id="topic" class="w-full border p-2 rounded-lg mb-2" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤" />
    <textarea id="detail" class="w-full border rounded-lg p-2 mb-2" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤" rows="3"></textarea>

    <label class="text-sm">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û:</label>
    <input id="imageInput" type="file" accept="image/*" class="my-4 w-full p-4" />

    <button onclick="submitRepair()" class="bg-green-600 text-white p-4 w-full rounded-full">‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</button>
     </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyVrI3t17jFiyQm6sfIGJl_oTK2uNEQ7HPdr8KOXtvd2NnhuxRCgV-rtigpzsBu_fQR/exec';
    const LIFF_ID = '2007335399-E7vDd1Pr';

    let userId = "", userName = "", userPosition = "", cameraStream = null;

    function showLoading(text = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î ..") {
      document.getElementById("loadingText").textContent = text;
      document.getElementById("loadingOverlay").classList.remove("hidden");
    }

    function hideLoading() {
      document.getElementById("loadingOverlay").classList.add("hidden");
    }

   window.onload = async () => {
        showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ..");
        await liff.init({ liffId: LIFF_ID });
      
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÉ‡∏ô LINE Client ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô ‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å liff.login()
        if (!liff.isInClient() && !liff.isLoggedIn()) {
          liff.login(); 
          return;  // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô reload
        }
      await liff.init({ liffId: LIFF_ID });
      const profile = await liff.getProfile();
      userId = profile.userId;

      try {
        const res = await fetch(`${API_URL}?method=getUserName&userId=${userId}`);
        const data = await res.json();
        if (data.found) {
          userName = data.name;
          userPosition = data.position;
        } else {
          userName = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:");
          userPosition = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:");
        }
      } catch (e) {
        userName = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:");
        userPosition = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:");
      }

      document.getElementById("profileInfo").innerText = `üë§ ${userName} (${userPosition})`;
      hideLoading();
    };

    async function submitRepair() {
      const deviceId = document.getElementById("deviceId").value.trim();
      const deviceName = document.getElementById("deviceName").value.trim();
      const topic = document.getElementById("topic").value.trim();
      const detail = document.getElementById("detail").value.trim();
      const file = document.getElementById("imageInput").files[0];

      if (!deviceId || !deviceName || !topic || !detail) {
        return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
      }

      let imageBase64 = "";
      if (file) imageBase64 = await toBase64(file);

      const payload = {
        action: "repair",
        userId,
        userName,
        deviceId,
        deviceName,
        topic,
        detail,
        imageBase64
      };

      showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ..");
      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(payload)
      });
      const text = await res.text();
      hideLoading();

      if (text === "success") {
        alert("üì¨ ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        document.querySelectorAll("input, textarea").forEach(e => e.value = "");
      } else {
        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + text);
      }
    }

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = e => reject(e);
        reader.readAsDataURL(file);
      });
    }

    async function startScan() {
      const video = document.getElementById("video");
      video.classList.remove("hidden");
      if (!cameraStream) {
        cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      }
      video.srcObject = cameraStream;
      video.play();
      requestAnimationFrame(() => scanQR(video));
    }

    function scanQR(video) {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height);
        if (code) {
          stopScan(video);
          const deviceId = code.data.trim();
          showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ..");
          fetch(`${API_URL}?method=getDevice&deviceId=${deviceId}`)
            .then(res => res.json())
            .then(data => {
              hideLoading();
              if (data.deviceId) {
                document.getElementById("deviceId").value = data.deviceId;
                document.getElementById("deviceName").value = data.deviceName;
              } else {
                alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå");
              }
            })
            .catch(err => {
              hideLoading();
              alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
            });
        }
      }
      if (cameraStream?.getVideoTracks()[0].enabled) {
        requestAnimationFrame(() => scanQR(video));
      }
    }

    function stopScan(video) {
      cameraStream.getVideoTracks().forEach(track => track.enabled = false);
      video.classList.add("hidden");
    }
  </script>
</body>
</html>
