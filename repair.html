<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <title>‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="max-w-md mx-auto bg-white p-6 rounded shadow">
    <h2 class="text-xl font-bold mb-4">üìã ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
    <div id="profileInfo" class="text-sm mb-4 text-gray-600"></div>

    <video id="video" class="hidden w-full rounded mb-2" playsinline></video>
    <button onclick="startScan()" class="bg-gray-800 text-white px-4 py-2 rounded mb-2 w-full">üì∑ ‡∏™‡πÅ‡∏Å‡∏ô QR ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>

    <input id="deviceId" class="w-full border p-2 mb-2" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå" />
    <input id="deviceName" class="w-full border p-2 mb-2" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå" />
    <input id="topic" class="w-full border p-2 mb-2" placeholder="‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏õ‡∏±‡∏ç‡∏´‡∏≤" />
    <textarea id="detail" class="w-full border p-2 mb-2" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î" rows="3"></textarea>

    <label class="text-sm">‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û:</label>
    <input type="file" id="imageInput" accept="image/*" class="mb-4 w-full" />

    <button onclick="submitRepair()" class="bg-blue-600 text-white px-4 py-2 w-full rounded">‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</button>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyVrI3t17jFiyQm6sfIGJl_oTK2uNEQ7HPdr8KOXtvd2NnhuxRCgV-rtigpzsBu_fQR/exec';
    const LIFF_ID = '2007335399-E7vDd1Pr';

    let userId = "", userName = "", cameraStream = null;

    window.onload = async () => {
      await liff.init({ liffId: LIFF_ID });
      const profile = await liff.getProfile();
      userId = profile.userId;

      const res = await fetch(`${API_URL}?method=getUserName&userId=${userId}`);
      const data = await res.json();
      userName = data.found ? data.name : prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏∏‡∏ì");
      document.getElementById("profileInfo").innerText = `üë§ ${userName} | üÜî ${userId}`;
    };

    async function submitRepair() {
      const deviceId = document.getElementById("deviceId").value.trim();
      const deviceName = document.getElementById("deviceName").value.trim();
      const topic = document.getElementById("topic").value.trim();
      const detail = document.getElementById("detail").value.trim();
      const file = document.getElementById("imageInput").files[0];

      if (!deviceId || !deviceName || !topic || !detail) {
        return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö");
      }

      let imageBase64 = "";
      if (file) {
        imageBase64 = await toBase64(file);
      }

      const payload = {
        action: "repair",
        userId, userName,
        deviceId, deviceName,
        topic, detail,
        imageBase64
      };

      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(payload)
      });

      const text = await res.text();
      if (text === "success") {
        alert("‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        document.querySelectorAll("input, textarea").forEach(e => e.value = "");
      } else {
        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + text);
      }
    }

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = e => reject(e);
        reader.readAsDataURL(file);
      });
    }

    async function startScan() {
      const video = document.getElementById("video");
      video.classList.remove("hidden");
      if (!cameraStream) {
        cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      }
      video.srcObject = cameraStream;
      video.play();
      requestAnimationFrame(() => scanQR(video));
    }

    function scanQR(video) {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        const canvas = document.createElement("canvas");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0);
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imageData.data, canvas.width, canvas.height);
        if (code) {
          stopScan(video);
          const deviceId = code.data.trim();
          fetch(`${API_URL}?method=getDevice&deviceId=${deviceId}`)
            .then(res => res.json())
            .then(data => {
              if (data.deviceId) {
                document.getElementById("deviceId").value = data.deviceId;
                document.getElementById("deviceName").value = data.deviceName;
              } else {
                alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå");
              }
            });
        }
      }
      if (cameraStream?.getVideoTracks()[0].enabled) {
        requestAnimationFrame(() => scanQR(video));
      }
    }

    function stopScan(video) {
      cameraStream.getVideoTracks().forEach(track => track.enabled = false);
      video.classList.add("hidden");
    }
  </script>
</body>
</html>
