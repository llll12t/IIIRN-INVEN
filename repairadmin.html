<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Admin - ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4">
  <h1 class="text-xl font-bold mb-4">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h1>

  <div class="mb-4">
    <label>‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</label>
    <select id="statusFilter" class="border p-2" onchange="renderTable()">
      <option value="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
      <option value="‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°">‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°</option>
      <option value="‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à">‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à</option>
    </select>
  </div>

  <table class="w-full text-sm border border-gray-300 mb-4">
    <thead class="bg-gray-200">
      <tr>
        <th class="border px-2 py-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
        <th class="border px-2 py-1">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
        <th class="border px-2 py-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th class="border px-2 py-1">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</th>
      </tr>
    </thead>
    <tbody id="repairTableBody"></tbody>
  </table>

  <div id="updateForm" class="hidden bg-white p-4 rounded shadow mt-8"></div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyXeUp84SZ8jLfTHtIrtYOmmt6RQqFSbqss1RlnbTqKobWZve5mob4m2YJDuQXjSuZ0Qw/exec';
    let allItems = [];

    window.onload = async () => {
      const res = await fetch(`${API_URL}?method=listRepairs`);
      allItems = await res.json();
      renderTable();
    };

    function renderTable() {
      const filter = document.getElementById("statusFilter").value;
      const tbody = document.getElementById("repairTableBody");
      tbody.innerHTML = "";

      const filtered = filter === "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" ? allItems : allItems.filter(item => item.status === filter);

      filtered.forEach(item => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="border px-2 py-1">${item.date}</td>
          <td class="border px-2 py-1">${item.deviceName}</td>
          <td class="border px-2 py-1">${item.status}</td>
          <td class="border px-2 py-1 text-center">
            <button onclick='editItem(${JSON.stringify(item)})' class="text-blue-600 underline">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function editItem(item) {
      const f = item.detail;
      const html = `
        <h2 class="text-lg font-bold mb-2">üõ†Ô∏è ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡∏ã‡πà‡∏≠‡∏°: ${item.deviceName}</h2>
        <input id="row" type="hidden" value="${item.row}">
        <input id="deviceId" type="hidden" value="${f.deviceId}">
        <select id="status" class="w-full border p-2 mb-2">
          <option value="‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°" ${item.status === '‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°' ? 'selected' : ''}>‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°</option>
          <option value="‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à" ${item.status === '‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à' ? 'selected' : ''}>‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à</option>
        </select>
        <input id="responsible" class="w-full border p-2 mb-2" value="${f.responsible}" placeholder="‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö">
        <input id="sendDate" type="date" class="w-full border p-2 mb-2" value="${toInputDate(f.sendDate)}">
        <input id="location" class="w-full border p-2 mb-2" value="${f.location}" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°">
        <input id="fixDate" type="date" class="w-full border p-2 mb-2" value="${toInputDate(f.fixDate)}">
        <input id="solution" class="w-full border p-2 mb-2" value="${f.solution}" placeholder="‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
        <input id="cost" class="w-full border p-2 mb-2" value="${f.cost}" placeholder="‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢">
        <label>‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ã‡πà‡∏≠‡∏°:</label>
        <input type="file" id="afterImg" class="w-full mb-2">
        <button onclick="submitUpdate()" class="bg-green-600 text-white px-4 py-2 w-full rounded">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      `;
      document.getElementById("updateForm").classList.remove("hidden");
      document.getElementById("updateForm").innerHTML = html;
    }

    async function submitUpdate() {
      const file = document.getElementById("afterImg").files[0];
      let imageBase64 = "";
      if (file) imageBase64 = await toBase64(file);

      const payload = {
        action: "updateRepair",
        row: parseInt(document.getElementById("row").value),
        deviceId: document.getElementById("deviceId").value,
        status: document.getElementById("status").value,
        responsible: document.getElementById("responsible").value,
        sendDate: document.getElementById("sendDate").value,
        location: document.getElementById("location").value,
        fixDate: document.getElementById("fixDate").value,
        solution: document.getElementById("solution").value,
        cost: document.getElementById("cost").value,
        imageBase64
      };

      const res = await fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(payload)
      });

      const text = await res.text();
      if (text === "success") {
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        location.reload();
      } else {
        alert("‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + text);
      }
    }

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = err => reject(err);
        reader.readAsDataURL(file);
      });
    }

    function toInputDate(text) {
      if (!text || !text.includes("-")) return "";
      const [d, m, y] = text.split("-");
      return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
    }
  </script>
</body>
</html>
