<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <h1 class="text-2xl font-bold mb-6">üìä Dashboard - ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°‡∏Ñ‡∏∑‡∏ô / ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h1>

  <!-- Summary Cards -->
  <div id="summaryCards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>

  <!-- Borrowers Section -->
  <h2 class="text-xl font-bold mb-2">üì¶ ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
  <div id="borrowerCards" class="grid md:grid-cols-2 gap-4 mb-6"></div>

  <!-- Repairs Table -->
  <h2 class="text-xl font-bold mb-2">üõ†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
  <table class="w-full text-sm border border-gray-300 bg-white mb-8">
    <thead class="bg-gray-200">
      <tr>
        <th class="border px-2 py-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
        <th class="border px-2 py-1">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
        <th class="border px-2 py-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
        <th class="border px-2 py-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
        <th class="border px-2 py-1">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
        <th class="border px-2 py-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô</th>
        <th class="border px-2 py-1">‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
        <th class="border px-2 py-1">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</th>
        <th class="border px-2 py-1">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</th>
      </tr>
    </thead>
    <tbody id="repairTable"></tbody>
  </table>

  <!-- Edit Modal -->
  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white p-6 rounded shadow w-full max-w-md">
      <h2 class="font-bold mb-2">üõ†Ô∏è ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h2>
      <input id="editRow" type="hidden">
      <div id="editDevice" class="text-sm mb-2"></div>
      <select id="editStatus" class="w-full border p-2 mb-2">
        <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
        <option value="‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°">‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°</option>
        <option value="‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à">‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à</option>
      </select>
      <input id="editLocation" class="w-full border p-2 mb-2" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°">
      <input id="editFixDate" type="date" class="w-full border p-2 mb-2">
      <input id="editSolution" class="w-full border p-2 mb-2" placeholder="‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
      <input id="editCost" class="w-full border p-2 mb-2" placeholder="‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢">
      <div class="flex gap-2">
        <button onclick="submitRepairUpdate()" class="bg-green-600 text-white px-4 py-2 rounded">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button onclick="closeModal()" class="bg-gray-400 text-white px-4 py-2 rounded">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

  <script>
    const API = 'https://script.google.com/macros/s/AKfycbyDKVSEwpiAspVQQkS5UMq7964Pa_nmKvrormbQvUc8mECN9vfbxnEppxmHuQN6OBBV/exec';

    async function loadDashboard() {
      // Summary
      const summary = await (await fetch(`${API}?method=dashboard`)).json();
      document.getElementById("summaryCards").innerHTML = `
        ${createCard("üë§ ‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°", summary.usersBorrowing, 'bg-blue-500')}
        ${createCard("üì¶ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô", summary.totalBorrow, 'bg-yellow-500')}
        ${createCard("üõ†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°", summary.repairPending, 'bg-red-500')}
        ${createCard("‚úÖ ‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à", summary.repairDone, 'bg-green-500')}
      `;

      // Borrowers
      const borrowers = await (await fetch(`${API}?method=listBorrowers`)).json();
      for (const user of borrowers) {
        const card = document.createElement("div");
        const borrow = await (await fetch(`${API}?method=getUserBorrow&userId=${user.userId}`)).json();
        const id = `borrow_${user.userId}`;
        card.className = "bg-white p-4 rounded shadow";
        card.innerHTML = `
          <div class="font-bold text-lg">üë§ ${user.name}</div>
          <div class="text-sm text-gray-600 mb-2">${user.position} | ${user.count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
          <div class="flex gap-2">
            <button onclick="toggle('${id}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm">üìÑ ‡∏î‡∏π</button>
            <button onclick='notify("${user.userId}", "${user.name}")' class="bg-red-600 text-white px-3 py-1 rounded text-sm">üîî ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</button>
          </div>
          <ul id="${id}" class="hidden list-disc ml-5 mt-2 text-sm text-gray-700">
            ${borrow.map(b => `<li>${b.deviceName} (${b.deviceId})</li>`).join("")}
          </ul>
        `;
        document.getElementById("borrowerCards").appendChild(card);
      }

      // Repairs
      const repairs = await (await fetch(`${API}?method=recentRepairs`)).json();
      const tbody = document.getElementById("repairTable");
      repairs.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="border px-2 py-1">${r.date}</td>
          <td class="border px-2 py-1">${r.deviceName}</td>
          <td class="border px-2 py-1">${r.topic}</td>
          <td class="border px-2 py-1">${r.status}</td>
          <td class="border px-2 py-1">${r.location}</td>
          <td class="border px-2 py-1">${r.fixDate}</td>
          <td class="border px-2 py-1">${r.solution}</td>
          <td class="border px-2 py-1">${r.cost}</td>
          <td class="border px-2 py-1 text-center">
            <button onclick="editRepair(${r.row})" class="text-blue-600 underline text-sm">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function createCard(title, value, color) {
      return `
        <div class="${color} text-white p-4 rounded shadow text-center">
          <div class="text-xl font-bold">${value}</div>
          <div class="text-sm">${title}</div>
        </div>
      `;
    }

    function toggle(id) {
      document.getElementById(id).classList.toggle("hidden");
    }

    async function notify(userId, name) {
      const devices = await (await fetch(`${API}?method=getUserBorrow&userId=${userId}`)).json();
      const payload = {
        action: "notifyReturn",
        userId,
        name,
        devices
      };
      const res = await fetch(API, { method: "POST", body: JSON.stringify(payload) });
      const text = await res.text();
      alert(text === "success" ? "‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢" : "‚ùå ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
    }

    async function editRepair(row) {
      const r = await (await fetch(`${API}?method=getRepairByRow&row=${row}`)).json();
      document.getElementById("editRow").value = row;
      document.getElementById("editDevice").textContent = r.deviceName + " - " + r.topic;
      document.getElementById("editStatus").value = r.status;
      document.getElementById("editLocation").value = r.location;
      document.getElementById("editFixDate").value = toInputDate(r.fixDate);
      document.getElementById("editSolution").value = r.solution;
      document.getElementById("editCost").value = r.cost;
      document.getElementById("editModal").classList.remove("hidden");
    }

    async function submitRepairUpdate() {
      const payload = {
        action: "updateRepairByRow",
        row: parseInt(document.getElementById("editRow").value),
        status: document.getElementById("editStatus").value,
        location: document.getElementById("editLocation").value,
        fixDate: document.getElementById("editFixDate").value,
        solution: document.getElementById("editSolution").value,
        cost: document.getElementById("editCost").value
      };
      const res = await fetch(API, {
        method: "POST",
        body: JSON.stringify(payload)
      });
      const text = await res.text();
      if (text === "success") {
        alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        closeModal();
        location.reload();
      } else {
        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
      }
    }

    function closeModal() {
      document.getElementById("editModal").classList.add("hidden");
    }

    function toInputDate(text) {
      if (!text || !text.includes("-")) return "";
      const [d, m, y] = text.split("-");
      return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
    }

    window.onload = loadDashboard;
  </script>
</body>
</html>
