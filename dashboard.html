<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .dot {
      animation: dot-flash 1.4s infinite;
    }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes dot-flash {
      0%, 80%, 100% { opacity: 0.3; }
      40% { opacity: 1; }
    }
  </style>
</head>
<body class="bg-gray-100 text-sm">

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 hidden">
  <div class="bg-white p-6 rounded-lg shadow text-center text-blue-900 font-semibold flex flex-col items-center">
    <div class="flex space-x-1 mb-2">
      <div class="dot w-2 h-2 bg-blue-800 rounded-full"></div>
      <div class="dot w-2 h-2 bg-blue-500 rounded-full"></div>
      <div class="dot w-2 h-2 bg-blue-300 rounded-full"></div>
    </div>
    <span>Loading..</span>
  </div>
</div>

  <div class="max-w-screen-xl mx-auto px-4 py-6">
    <h1 class="text-2xl font-bold mb-6">üìä Dashboard - ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏∑‡∏°‡∏Ñ‡∏∑‡∏ô / ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h1>

    <div id="summaryCards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>

    <h2 class="text-xl font-bold mb-2">üì¶ ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
    <div id="borrowerCards" class="grid md:grid-cols-2 gap-4 mb-6"></div>

    <h2 class="text-xl font-bold mb-2">üõ†Ô∏è ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
    <table class="min-w-full text-sm border border-gray-300 bg-white mb-8">
      <thead class="bg-gray-200 text-left">
        <tr>
          <th class="border px-2 py-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
          <th class="border px-2 py-1">‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</th>
          <th class="border px-2 py-1">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</th>
          <th class="border px-2 py-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
          <th class="border px-2 py-1">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</th>
          <th class="border px-2 py-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô</th>
          <th class="border px-2 py-1">‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
          <th class="border px-2 py-1">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</th>
          <th class="border px-2 py-1">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï</th>
        </tr>
      </thead>
      <tbody id="repairTable"></tbody>
    </table>
  </div>

  <!-- Modal -->
  <div id="editModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-60 z-50 hidden">
    <div class="bg-white p-6 rounded shadow-md w-full max-w-md">
      <h2 class="text-lg font-bold mb-4">üõ†Ô∏è ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°</h2>
      <input type="hidden" id="editRow">
      <input type="hidden" id="editDeviceId">
      <input type="text" id="editResponsible" placeholder="‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö" class="w-full border p-2 mb-2">
      <input type="date" id="editSendDate" class="w-full border p-2 mb-2">
      <select id="editStatus" class="w-full border p-2 mb-2">
        <option value="‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£">‡∏£‡∏≠‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</option>
        <option value="‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°">‡∏™‡πà‡∏á‡∏ã‡πà‡∏≠‡∏°</option>
        <option value="‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à">‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à</option>
      </select>
      <input id="editLocation" class="w-full border p-2 mb-2" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ã‡πà‡∏≠‡∏°">
      <input id="editFixDate" type="date" class="w-full border p-2 mb-2">
      <input id="editSolution" class="w-full border p-2 mb-2" placeholder="‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
      <input id="editCost" class="w-full border p-2 mb-2" placeholder="‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢ (‡∏ö‡∏≤‡∏ó)">
      <input type="file" id="editImage" class="w-full mb-2">
      <div class="flex justify-end gap-2">
        <button onclick="submitRepairUpdate()" class="bg-green-600 text-white px-4 py-2 rounded">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button onclick="closeModal()" class="bg-gray-500 text-white px-4 py-2 rounded">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

  <script>
    const API = 'https://script.google.com/macros/s/AKfycbyDKVSEwpiAspVQQkS5UMq7964Pa_nmKvrormbQvUc8mECN9vfbxnEppxmHuQN6OBBV/exec';

    function showLoading(state = true) {
      document.getElementById("loadingOverlay").classList.toggle("hidden", !state);
    }

    function closeModal() {
      document.getElementById("editModal").classList.add("hidden");
    }

    function toInputDate(text) {
      if (!text || !text.includes("-")) return "";
      const [d, m, y] = text.split("-");
      return `${y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
    }

    function toBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    async function loadDashboard() {
      showLoading(true);
      const [summary, borrowers, repairs] = await Promise.all([
        fetch(`${API}?method=dashboard`).then(r => r.json()),
        fetch(`${API}?method=listBorrowers`).then(r => r.json()),
        fetch(`${API}?method=recentRepairs`).then(r => r.json())
      ]);

      document.getElementById("summaryCards").innerHTML = `
        ${createCard("üë§ ‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°", summary.usersBorrowing, 'bg-blue-500')}
        ${createCard("üì¶ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏∑‡∏ô", summary.totalBorrow, 'bg-yellow-500')}
        ${createCard("üõ†Ô∏è ‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°", summary.repairPending, 'bg-red-500')}
        ${createCard("‚úÖ ‡∏ã‡πà‡∏≠‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à", summary.repairDone, 'bg-green-500')}
      `;

      const borrowerCards = document.getElementById("borrowerCards");
      borrowerCards.innerHTML = "";
      for (const user of borrowers) {
        const list = await fetch(`${API}?method=getUserBorrow&userId=${user.userId}`).then(r => r.json());
        const id = `borrow_${user.userId}`;
        const el = document.createElement("div");
        el.className = "bg-white p-4 rounded shadow";
        el.innerHTML = `
          <div class="font-bold text-lg">üë§ ${user.name}</div>
          <div class="text-sm text-gray-600 mb-2">${user.position} | ${list.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
          <div class="flex gap-2">
            <button onclick="toggleList('${id}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm">üìÑ ‡∏î‡∏π</button>
            <button onclick='notify("${user.userId}", "${user.name}")' class="bg-red-600 text-white px-3 py-1 rounded text-sm">üîî ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</button>
          </div>
          <ul id="${id}" class="hidden list-disc ml-5 mt-2 text-sm text-gray-700">
            ${list.map(b => `<li>${b.deviceName} (${b.deviceId})</li>`).join("")}
          </ul>
        `;
        borrowerCards.appendChild(el);
      }

      const tbody = document.getElementById("repairTable");
      tbody.innerHTML = "";
      repairs.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="border px-2 py-1">${r.date}</td>
          <td class="border px-2 py-1">${r.deviceName}</td>
          <td class="border px-2 py-1">${r.topic}</td>
          <td class="border px-2 py-1">${r.status}</td>
          <td class="border px-2 py-1">${r.location}</td>
          <td class="border px-2 py-1">${r.fixDate}</td>
          <td class="border px-2 py-1">${r.solution}</td>
          <td class="border px-2 py-1">${r.cost}</td>
          <td class="border px-2 py-1 text-center">
            <button onclick="editRepair(${r.row})" class="text-blue-600 underline">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      showLoading(false);
    }

    function createCard(title, value, color) {
      return `<div class="${color} text-white p-4 rounded shadow text-center">
        <div class="text-xl font-bold">${value}</div>
        <div class="text-sm">${title}</div>
      </div>`;
    }

    function toggleList(id) {
      document.getElementById(id).classList.toggle("hidden");
    }

    async function notify(userId, name) {
      showLoading(true);
      const devices = await fetch(`${API}?method=getUserBorrow&userId=${userId}`).then(r => r.json());
      const res = await fetch(API, {
        method: "POST",
        body: JSON.stringify({ action: "notifyReturn", userId, name, devices })
      });
      alert(await res.text());
      showLoading(false);
    }

    async function editRepair(row) {
      showLoading(true);
      const r = await fetch(`${API}?method=getRepairByRow&row=${row}`).then(r => r.json());
      document.getElementById("editRow").value = r.row;
      document.getElementById("editDeviceId").value = r.deviceId || '';
      document.getElementById("editStatus").value = r.status;
      document.getElementById("editResponsible").value = r.responsible || '';
      document.getElementById("editSendDate").value = toInputDate(r.sendDate);
      document.getElementById("editLocation").value = r.location;
      document.getElementById("editFixDate").value = toInputDate(r.fixDate);
      document.getElementById("editSolution").value = r.solution;
      document.getElementById("editCost").value = r.cost;
      document.getElementById("editModal").classList.remove("hidden");
      showLoading(false);
    }

    async function submitRepairUpdate() {
      showLoading(true);
      const file = document.getElementById("editImage").files[0];
      const imageBase64 = file ? await toBase64(file) : "";

      const payload = {
        action: "updateRepair",
        row: parseInt(document.getElementById("editRow").value),
        deviceId: document.getElementById("editDeviceId").value,
        status: document.getElementById("editStatus").value,
        responsible: document.getElementById("editResponsible").value,
        sendDate: document.getElementById("editSendDate").value,
        location: document.getElementById("editLocation").value,
        fixDate: document.getElementById("editFixDate").value,
        solution: document.getElementById("editSolution").value,
        cost: document.getElementById("editCost").value,
        imageBase64
      };

      const res = await fetch(API, {
        method: "POST",
        body: JSON.stringify(payload)
      });
      const text = await res.text();
      showLoading(false);
      if (text === "success") {
        alert("‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        closeModal();
        location.reload();
      } else {
        alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + text);
      }
    }

    window.onload = loadDashboard;
  </script>
</body>

</html>
