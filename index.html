<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Borrow Devices</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="flex flex-col items-center justify-center min-h-screen bg-gray-100 p-4">
<div class="bg-white p-6 rounded shadow w-full max-w-md text-center">
  <h1 class="text-2xl font-bold mb-4">üì¶ Borrow Devices</h1>

  <button onclick="scanCodeV2()" class="bg-blue-500 text-white px-6 py-3 rounded mb-4 w-full">
    üì∑ Scan QR Code
  </button>

  <div id="loadingMessage" class="text-sm text-blue-500 mb-2"></div> <!-- NEW: Loading Message -->
  <div id="basketList" class="text-gray-700 mb-4"></div>

  <input id="borrowerName" type="text" placeholder="Your Name" class="border rounded w-full p-2 mb-4">
  <button onclick="submitBasket()" class="bg-green-500 text-white px-6 py-3 rounded w-full">
    ‚úÖ Submit Borrow
  </button>
</div>

<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbxEdiFTpzQC4R6TdsRPqUJp3o-xSIhLUaIzD4yWqwh7_WlgAyvDOFWPRYAiNgLxTvDw/exec'; 
  let basket = [];
  let userId = '';

window.onload = async () => {
  await liff.init({ liffId: '2007335399-deQzG3E7' });

  if (!liff.isLoggedIn()) {
    liff.login({
      scope: ['profile', 'openid', 'scan'],
      redirectUri: window.location.href
    });
  } else {
    const profile = await liff.getProfile();
    userId = profile.userId;
  }
  renderBasket();
};

  async function scanCodeV2() {
    try {
      const result = await liff.scanCodeV2();
      const scannedValue = result.value;
      await addDeviceToBasket(scannedValue);
    } catch (error) {
      console.error(error);
      alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡πÑ‡∏î‡πâ: ' + error.message);
    }
  }

  async function addDeviceToBasket(deviceId) {
    try {
      document.getElementById('loadingMessage').innerText = 'üîé ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå...'; // NEW: Loading text
      const res = await fetch(`${API_URL}?method=getDevice&deviceId=${deviceId}`);
      const device = await res.json();

      if (device.deviceId) {
        basket.push(device);
        renderBasket();
      } else {
        alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ô‡∏µ‡πâ');
      }
    } catch (error) {
      console.error(error);
      alert('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message);
    } finally {
      document.getElementById('loadingMessage').innerText = ''; // NEW: clear loading text
    }
  }

  function renderBasket() {
    const container = document.getElementById('basketList');
    if (basket.length === 0) {
      container.innerHTML = '<p class="text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>';
      return;
    }

    container.innerHTML = '<ul class="text-left">';
    basket.forEach((item, index) => {
      container.innerHTML += `
        <li class="flex justify-between items-center border-b py-2">
          ${item.deviceId} - ${item.deviceName}
          <button onclick="removeFromBasket(${index})" class="text-red-500">üóëÔ∏è</button>
        </li>
      `;
    });
    container.innerHTML += '</ul>';
  }

  function removeFromBasket(index) {
    basket.splice(index, 1);
    renderBasket();
  }

  async function submitBasket() {
    const borrowerName = document.getElementById('borrowerName').value.trim();
    if (!borrowerName) {
      alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏¢‡∏∑‡∏°');
      return;
    }
    if (basket.length === 0) {
      alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤');
      return;
    }

    const borrowList = basket.map(d => ({
      deviceId: d.deviceId,
      deviceName: d.deviceName,
      borrowerName,
      userId
    }));

    console.log('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡∏™‡πà‡∏á:', borrowList); // NEW: Debug ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á

    try {
      const res = await fetch(`${API_URL}?method=borrow`, {
        method: 'POST',
        body: JSON.stringify(borrowList),
        headers: {
          'Content-Type': 'application/json'
        }
      });

      const text = await res.text();
      if (text === 'success') {
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
        basket = [];
        renderBasket();
        document.getElementById('borrowerName').value = '';
      } else {
        console.error('‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:', text); // ‡πÄ‡∏û‡∏¥‡πà‡∏° Debug response
        alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      }
    } catch (error) {
      console.error('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:', error);
      alert('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ' + error.message);
    }
  }
</script>

</body>
</html>
